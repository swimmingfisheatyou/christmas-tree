<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>fireworks</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      background: #000; overflow: hidden;
    }

    /* 底层：星空视频（不拦截点击） */
    #bg-video {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 0;
      pointer-events: none;
      background: #000;
    }

    /* 中层：烟花画布 */
    #canvas {
      position: fixed; inset: 0;
      z-index: 1; display: block;
    }

    /* 顶层：底部两侧图标容器（用 flex 分布到两端） */
#icons {
  position: fixed;
  bottom: 150px;
  left: 0; right: 0;
  display: flex;
  justify-content: center;   /* 两个图标在中间 */
  gap: 200px;                /* 两个图标之间的距离，你可以改大小 */
  z-index: 2;
  pointer-events: none;
}

/* 两侧可点击图标（注意：不要再有 position:absolute） */
#icons .clickable-icon {
  width: clamp(100px, 15vw, 200px);  /* 自适应，不会无限变大 */
  height: auto;
  pointer-events: auto;              /* 接收点击 */
  cursor: pointer;
  user-select: none;
  -webkit-user-drag: none;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.5));
  transform-origin: 50% 100%;
}

    /* 左右摇晃动画（2s） */
    @keyframes shake-lr {
      0%   { transform: translateX(0) rotate(0deg); }
      10%  { transform: translateX(-4px) rotate(-2deg); }
      20%  { transform: translateX(4px)  rotate(2deg); }
      30%  { transform: translateX(-4px) rotate(-2deg); }
      40%  { transform: translateX(4px)  rotate(2deg); }
      50%  { transform: translateX(-3px) rotate(-1.5deg); }
      60%  { transform: translateX(3px)  rotate(1.5deg); }
      70%  { transform: translateX(-2px) rotate(-1deg); }
      80%  { transform: translateX(2px)  rotate(1deg); }
      90%  { transform: translateX(-1px) rotate(-0.5deg); }
      100% { transform: translateX(0) rotate(0deg); }
    }
    .shake { animation: shake-lr 2s ease-in-out; }
  </style>
</head>
<body>

  <!-- 底层星空视频（建议文件名不含空格；若原名是 starry sky.mp4 也可用） -->
  <video
    id="bg-video"
    src="starry-sky.mp4"
    autoplay
    muted
    loop
    playsinline
    preload="auto"
  ></video>

  <!-- 中层烟花画布 -->
  <canvas id="canvas"></canvas>

  <!-- 顶层底部两侧图片（点击只摇晃，不放烟花/不触发音乐） -->
  <div id="icons">
    <img src="photo-1.png" alt="icon left"  class="clickable-icon left">
    <img src="photo-2.png" alt="icon right" class="clickable-icon right">
  </div>

  <script>
    /* ===== 常量区 ===== */
    const PARTICLES_PER_FIREWORK = 150;
    const FIREWORK_CHANCE        = 0.02;
    const BASE_PARTICLE_SPEED    = 0.6;
    const FIREWORK_LIFESPAN      = 600;
    const PARTICLE_INITIAL_SPEED = 4.5;
    const GRAVITY                = 9.8;
    const TEXT_OFFSET_Y = -100;   // 负数 = 向上移动，正数 = 向下移动


    // 文本自适应参数（可以按需调）
    const TEXT               = "Wish 409 a happy day!";
    const TEXT_MAX_W_RATIO   = 0.70;   // 文字最大占画布宽度比例（左右更留白）
    const TEXT_MAX_H_RATIO   = 0.18;   // 文字最大占画布高度比例
    const TEXT_MIN_PX        = 18;
    const TEXT_FONT_FAMILY   = '"Brush Script MT", cursive';
    const TEXT_SCALE_FALLBACK= 0.14;   // 极端情况下的兜底比例

    /* ===== 文字自适应：二分法计算字号 ===== */
    function fitFontSize(ctx, text, maxW, maxH) {
      let low = TEXT_MIN_PX;
      let high = Math.max(low, Math.min(maxH * 2, Math.max(canvas.width, canvas.height)));
      for (let i = 0; i < 18; i++) {
        const mid = (low + high) / 2;
        ctx.font = `${mid}px ${TEXT_FONT_FAMILY}`;
        const m = ctx.measureText(text);
        const w = m.width;
        const h = (m.actualBoundingBoxAscent ?? mid * 0.8) + (m.actualBoundingBoxDescent ?? mid * 0.2);
        if (w <= maxW && h <= maxH) low = mid; else high = mid;
      }
      return Math.floor(low);
    }

    /* ===== 画布 & 音乐 ===== */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let disableAutoFireworks = false;
    let resetDisable = 0;
    let musicPlayed = false;

    // 首次点击画布才播放音乐（循环）
    const audio = new Audio('EVA.mp3');
    audio.loop = true;

    function updateCanvasSize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    updateCanvasSize();
    $(window).on('resize', updateCanvasSize);

    // 极少数浏览器 loop 闪黑兜底
    const bg = document.getElementById('bg-video');
    bg.addEventListener('ended', () => { bg.play().catch(()=>{}); });

    /* ===== 主循环 ===== */
    function loop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 渐变文字
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0,   'red');
      gradient.addColorStop(0.2, 'orange');
      gradient.addColorStop(0.4, 'yellow');
      gradient.addColorStop(0.6, 'green');
      gradient.addColorStop(0.8, 'blue');
      gradient.addColorStop(1,   'purple');

      const maxW = canvas.width  * TEXT_MAX_W_RATIO;
      const maxH = canvas.height * TEXT_MAX_H_RATIO;
      let fontSize = fitFontSize(ctx, TEXT, maxW, maxH);
      if (!fontSize || fontSize < TEXT_MIN_PX) {
        fontSize = Math.max(TEXT_MIN_PX, Math.floor(Math.min(canvas.width, canvas.height) * TEXT_SCALE_FALLBACK));
      }
      ctx.font = `${fontSize}px ${TEXT_FONT_FAMILY}`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      // 描边 + 填充
      ctx.lineWidth = Math.max(2, fontSize * 0.035);
      ctx.strokeStyle = 'rgba(0,0,0,0.55)';
      ctx.strokeText(TEXT, canvas.width / 2, canvas.height / 2 + TEXT_OFFSET_Y);
      ctx.fillStyle = gradient;
      ctx.fillText(TEXT,   canvas.width / 2, canvas.height / 2 + TEXT_OFFSET_Y);

      // 自动烟花
      if (!disableAutoFireworks && Math.random() < FIREWORK_CHANCE) createFirework();

      // 粒子更新
      particles.forEach((p, i) => {
        p.animate(); p.render();
        if (p.y > canvas.height || p.x < 0 || p.x > canvas.width || p.alpha <= 0) {
          particles.splice(i, 1);
        }
      });

      requestAnimationFrame(loop);
    }

    /* ===== 烟花 & 粒子 ===== */
    function createFirework(x = Math.random() * canvas.width, y = Math.random() * canvas.height) {
      let speed = (Math.random() * 2) + BASE_PARTICLE_SPEED;
      let maxSpeed = speed;
      let red = ~~(Math.random() * 255);
      let green = ~~(Math.random() * 255);
      let blue = ~~(Math.random() * 255);
      red = (red < 150 ? red + 150 : red);
      green = (green < 150 ? green + 150 : green);
      blue = (blue < 150 ? blue + 150 : blue);

      for (let i = 0; i < PARTICLES_PER_FIREWORK; i++) {
        const p = new Particle(x, y, red, green, blue, speed);
        particles.push(p);
        maxSpeed = (speed > maxSpeed ? speed : maxSpeed);
      }
      for (let i = 0; i < 40; i++) {
        const p = new Particle(x, y, red, green, blue, maxSpeed, true);
        particles.push(p);
      }
    }

    class Particle {
      constructor(x = 0, y = 0, red = ~~(Math.random() * 255), green = ~~(Math.random() * 255), blue = ~~(Math.random() * 255), speed, isFixedSpeed) {
        this.x = x; this.y = y;
        this.red = red; this.green = green; this.blue = blue;
        this.alpha = 0.05; this.radius = 1 + Math.random();
        this.angle = Math.random() * 360;
        this.speed = (Math.random() * speed) + 0.1;
        this.velocityX = Math.cos(this.angle) * this.speed;
        this.velocityY = Math.sin(this.angle) * this.speed;
        this.startTime = Date.now();
        this.duration = Math.random() * 300 + FIREWORK_LIFESPAN;
        this.currentDuration = 0;
        this.dampening = 30;
        this.colour = this.getColour();
        if (isFixedSpeed) {
          this.speed = speed;
          this.velocityY = Math.sin(this.angle) * this.speed;
          this.velocityX = Math.cos(this.angle) * this.speed;
        }
        this.initialVelocityX = this.velocityX;
        this.initialVelocityY = this.velocityY;
      }
      animate() {
        this.currentDuration = Date.now() - this.startTime;
        if (this.currentDuration <= 200) {
          this.x += this.initialVelocityX * PARTICLE_INITIAL_SPEED;
          this.y += this.initialVelocityY * PARTICLE_INITIAL_SPEED;
          this.alpha += 0.01;
          this.colour = this.getColour(240, 240, 240, 0.9);
        } else {
          this.x += this.velocityX;
          this.y += this.velocityY;
          this.colour = this.getColour(this.red, this.green, this.blue, 0.4 + (Math.random() * 0.3));
        }
        this.velocityY += GRAVITY / 1000;
        if (this.currentDuration >= this.duration) {
          this.velocityX -= this.velocityX / this.dampening;
          this.velocityY -= this.velocityY / this.dampening;
        }
        if (this.currentDuration >= this.duration + this.duration / 1.1) {
          this.alpha -= 0.02;
          this.colour = this.getColour();
        } else if (this.alpha < 1) {
          this.alpha += 0.03;
        }
      }
      render() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, true);
        ctx.fillStyle = this.colour;
        ctx.shadowBlur = 8;
        ctx.shadowColor = this.getColour(this.red + 150, this.green + 150, this.blue + 150, 1);
        ctx.fill();
      }
      getColour(red, green, blue, alpha) {
        return `rgba(${red ?? this.red}, ${green ?? this.green}, ${blue ?? this.blue}, ${alpha ?? this.alpha})`;
      }
    }

    /* ===== 事件绑定 ===== */

    // 点击画布：首次播放音乐 + 放烟花
    $(canvas).on('click', (e) => {
      if (!musicPlayed) {
        audio.play().catch(()=>{});
        musicPlayed = true;
      }
      createFirework(e.clientX, e.clientY);
      disableAutoFireworks = true;
      clearTimeout(resetDisable);
      resetDisable = setTimeout(() => { disableAutoFireworks = false; }, 5000);
    });

    // 点击图标：只摇晃，不触发烟花
    $('#icons').on('click', '.clickable-icon', function (e) {
      e.preventDefault();
      e.stopPropagation(); // 不冒泡到 canvas

    // 额外：点击图标时也能触发音乐
    if (!musicPlayed) {
    audio.play().catch(()=>{});
    musicPlayed = true;
  }

      const $img = $(this);
      $img.removeClass('shake');
      // 强制回流，确保每次都能重新触发动画
      // eslint-disable-next-line no-unused-expressions
      this.offsetWidth;
      $img.addClass('shake');

      setTimeout(() => $img.removeClass('shake'), 2000);
    });

    /* 启动主循环 */
    loop();
  </script>
</body>
</html>
